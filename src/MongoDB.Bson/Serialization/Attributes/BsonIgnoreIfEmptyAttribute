using System;
using System.Collections;
using System.Net.Http.Headers;

namespace MongoDB.Bson.Serialization.Attributes
{
    /// <summary>
    /// Indicates whether a field or property is null, an empty string or empty array/collection and should be ignored when serializing this class.
    /// </summary>
    [AttributeUsage(AttributeTargets.Property | AttributeTargets.Field)]
    public class BsonIgnoreIfEmptyAttribute : Attribute, IBsonMemberMapAttribute
    {
       
        // constructors
        /// <summary>
        /// Initializes a new instance of the BsonIgnoreIfDefaultAttribute class.
        /// </summary>
        public BsonIgnoreIfEmptyAttribute()
        {
        }

        
        // public methods
        /// <summary>
        /// Applies a modification to the member map.
        /// </summary>
        /// <param name="memberMap">The member map.</param>
        public void Apply(BsonMemberMap memberMap)
        {
            memberMap.SetShouldSerializeMethod(
                obj =>
                {
                    object value = memberMap.Getter(obj);
                    switch (value)
                    {
                        case null:
                            return false;
                        case string s:
                            return s != "";
                        case ICollection col:
                            return col.Count != 0;
                        default:
                            return true;
                    }
                }
                );
        }
    }
}
